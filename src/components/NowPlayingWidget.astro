---
// Gem City "Now Playing" widget showing live portfolio data
const PORTFOLIO_STATUS_URL = 'https://vivi.rocks/api/status';

let status = null;
let error = null;

try {
  const response = await fetch(PORTFOLIO_STATUS_URL, { 
    method: 'GET',
    headers: { 'Accept': 'application/json' }
  });
  if (response.ok) {
    status = await response.json();
  }
} catch (e) {
  error = 'Portfolio offline';
}

const formatTime = (isoString: string) => {
  return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};
---

{status && (
  <div class="border border-border/50 rounded-lg p-4 bg-muted/20">
    <div class="flex items-center gap-2 mb-3">
      <span class="relative flex h-2 w-2">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
      </span>
      <span class="text-xs font-mono text-muted-foreground uppercase tracking-wider">Live from vivi.rocks</span>
    </div>
    
    <div class="space-y-2 text-sm">
      <div class="flex items-start gap-2">
        <span class="text-muted-foreground">Currently:</span>
        <span class="text-foreground">{status.activity}</span>
      </div>
      
      <div class="flex items-center gap-2">
        <span class="text-muted-foreground">Staring at:</span>
        <span class="text-foreground">{status.background.name}</span>
      </div>
      
      {status.music.isPlaying && (
        <div class="flex items-center gap-2">
          <span class="text-muted-foreground">Probably listening to:</span>
          <span class="text-foreground italic">{status.music.track}</span>
        </div>
      )}
      
      <div class="flex items-center gap-2 text-xs text-muted-foreground/70 pt-2 border-t border-border/30 mt-2">
        <span>Updated: {formatTime(status.lastUpdated)}</span>
        <span>|</span>
        <a href={status.portfolioUrl} target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">
          Visit portfolio â†’
        </a>
      </div>
    </div>
  </div>
)}

{error && (
  <div class="border border-border/50 rounded-lg p-4 bg-muted/10 text-sm text-muted-foreground">
    <p>Portfolio connection unavailable.</p>
    <p class="text-xs mt-1">Vivi might be in the zone. Try again later.</p>
  </div>
)}
